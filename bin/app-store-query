#!/usr/bin/env bash

set -Eeuo pipefail

_log() { echo "$*" 1>&2; }

log() { $VERBOSE || return 0; $QUIET && return 0; _log "--> $*"; }
info() { $QUIET && return 0; _log "--> $*"; }
err() { _log "--> ERROR: $*"; }
die() { _log "--> FATAL: $*"; exit 1; }

trap 'main "$@"' EXIT

THIS_SCRIPT="$0"
ITUNES_API="https://itunes.apple.com/search"
CACHE_ROOT="$TMPDIR/home/bin/app-store-query"

# Flag options.
JSON=false
PLIST=false
RAW=false
QUIET=false
VERBOSE=false
REFRESH=false

MAX_AGE_MINUTES=20
MAX_AGE_SECONDS=$(( 60 * MAX_AGE_MINUTES ))

main() {
	[[ $# -gt 1 ]] || die_usage
	run_subcommand_and_exit "$@"
	die "$(usage)"
}

usage() {
	echo "Search the uk app store"
	echo "Usage:"
	echo "  $(basename "$THIS_SCRIPT") search <term>"
}

die_usage() { _log "$(usage)"; exit 1; }

run_subcommand_and_exit() { local NAME="$1"; shift
	local ARGS=()
	while [[ $# -gt 0 ]]; do
		case "$1" in
			-j|--json)
				JSON=true; shift
				;;
			-p|--plist)
				PLIST=true; shift
				;;
			-r|--raw)
				RAW=true; shift
				;;
			-R|--refresh)
				REFRESH=true; shift
				;;
			-q|--quiet)
				QUIET=true; shift
				;;
			-v|--verbose)
				VERBOSE=true; shift
				;;
			*)
				ARGS+=("$1"); shift
				;;
		esac
	done
	set -- "${ARGS[@]}"
	$JSON && $PLIST && die "You can only specify json or plist, not both."
	func_exists "cmd_$NAME" || die "No subcommand named '$NAME'"
	"cmd_$NAME" "$@"; exit $?
}

cmd_search() { local TERM="$1" URL=""
	URL="$(search_url "$TERM")"
	get "$URL" present_searchresults
}

get() { local URL="$1" PRESENTER="$2" RESULT="" STATUS="OK" FROM=""
	log "GET $URL"
	export RESULT STATUS
	trap '$PRESENTER "$RESULT"; log "$STATUS: Loaded from $FROM" && trap - RETURN' RETURN
	FROM=cache
	RESULT="$(load_from_cache "$URL")" && return 0 
	FROM=web
	RESULT="$(curl -f --silent --show-error "$URL")" || { STATUS="Failed"; return 1; }
	save_to_cache "$URL" "$RESULT"
}

present_searchresults() {
	$RAW   && { echo "$1"; return; }
	$JSON  && { jq . <<< "$1"; return; }
	$PLIST && { plutil -convert xml1 - -o - <<< "$1"; return; }
	{
		echo $'App ID\tName\tDeveloper\tWebsite'
		echo $'------\t----\t---------\t-------'
		echo "$1" | jq -r \
		'.results[] | "\(.trackId)\t\(.trackName)\t\(.artistName)\t\(.sellerUrl // "-")"'
	} |	column -t -s$'\t'
}

save_to_cache() { local URL="$1" RESULT="$2"
	CACHE="$(url_cache_path "$URL")"
	echo "$RESULT" > "$CACHE" && return 0
	log "Failed to cache result."
	return 1
}

load_from_cache() { local URL="$1" AGE_SECONDS
	$REFRESH && {
		log "Skipping cache check - refresh requqested."
		return 1
	}
	CACHE="$(url_cache_path "$URL")"
	[[ ! -f "$CACHE" ]] && return 1
	AGE_SECONDS="$(($(date +%s) - $(date -r "$CACHE" +%s)))"
	[[ "$AGE_SECONDS" -gt "$MAX_AGE_SECONDS" ]] && {
		log "Cache expired: $CACHE"
		return 1
	}
	cat "$CACHE" && { log "Loaded from cache (${AGE_SECONDS}s old): $CACHE"; return 0; }
	return 1
}

url_cache_path() { local URL="$1" CACHE_PATH=""
	CACHE_PATH="$CACHE_ROOT/$(digest "$URL")"
	mkdir -p "$(dirname "$CACHE_PATH")"
	echo "$CACHE_PATH"
}

digest() { local STRING="$1"
	sha256sum <<< "$STRING" | cut -d' ' -f1
}

func_exists() { local NAME="$1"; [[ $(type -t "$NAME") == function ]]; }

search_url() { local TERM="$1" COUNTRY="gb" MEDIA="software" ENTITY="software" QUERY=""
	QUERY="$(printf "term=%s&country=%s&&media=%s&entity=%s" \
		"$TERM" \
		"$COUNTRY" \
		"$MEDIA" \
		"$ENTITY" \
	)"
	echo "${ITUNES_API}?${QUERY}"
}
